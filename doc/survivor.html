<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Survivor Profile</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    * { margin:0; padding:0; box-sizing:border-box }
    body { background:#111; color:#ddd; font-family:Arial,sans-serif }
    #widget { max-width:360px; margin:20px auto; position:relative }
    h1 { text-align:center; color:#ccc; font-size:1.8rem; margin-bottom:16px }
    #errorLog { display:none; background:#440000; color:#f88; padding:10px; margin-bottom:12px; font-family:monospace; text-align:center; }

    .card { width:100%; aspect-ratio:360/504; perspective:1000px; margin-bottom:12px }
    .card .inner { position:relative; width:100%; height:100%; transform-style:preserve-3d; transition:transform .6s; }
    .card.flip .inner { transform:rotateY(180deg) }

    .front, .back {
      position:absolute; inset:0; backface-visibility:hidden;
      background:#2b2b2b; border-radius:12px;
      box-shadow:0 6px 12px rgba(0,0,0,0.6);
      display:flex; flex-direction:column; padding:20px;
    }
    .front { transform:rotateY(0deg); }
    .back  { transform:rotateY(180deg); }

    .header, .footer { display:flex; justify-content:space-between; margin-bottom:16px; }
    .avatar, .slot {
      width:48px; height:48px; background:#444; border-radius:50%;
      display:flex; align-items:center; justify-content:center; font-size:1.5rem;
    }

    .stats {
      display:grid; grid-template-columns:repeat(4,1fr); gap:8px; flex-grow:1;
    }
    .stat { background:#3a3a3a; padding:8px; border-radius:6px; text-align:center; }
    .stat small { color:#999; font-size:.75rem; display:block; }
    .stat strong { color:#eee; font-size:1.1rem; display:block; }

    button {
      background:#444; color:#ddd; border:none; border-radius:6px;
      padding:8px 12px; cursor:pointer; font-size:.9rem;
    }
    .footer button { flex:1; margin:0 8px; }
    .front > button, .back > button { width:100%; margin:8px 0; }
    .actions button { margin:0 6px; }

    .modal {
      display:none; position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%);
      background:#2b2b2b; border-radius:12px;
      box-shadow:0 6px 12px rgba(0,0,0,0.6);
      width:90%; max-width:320px; padding:20px; z-index:1000;
    }
    .modal h2 { color:#ccc; margin-bottom:12px; text-align:center; }
    #question-form div { margin-bottom:12px; }
    #question-form label { display:block; }
    .emoji { margin-right:4px; }

    .back h3 { color:#ccc; margin-bottom:12px; }
    .back ul { list-style:disc inside; color:#ddd; margin-bottom:16px; }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

  <!-- 1) Inline JSON data for encounters -->
  <script type="application/json" class="enc">
  [
    {
      "id":"stranger",
      "name":"Mysterious Stranger",
      "icon":"üïµÔ∏è‚Äç‚ôÇÔ∏è","svg":"user-secret",
      "description":"A cloaked figure offers you choices‚Ä¶",
      "trust":0,
      "questions":[
        {
          "prompt":"Do you trust the stranger?",
          "icon":"‚ùì","svg":"question-circle",
          "options":[
            {"text":"Yes","icon":"‚úÖ","svg":"check","reward":{"stats":{"end":1,"agi":1},"items":["Coin"]}},
            {"text":"No","icon":"‚ùå","svg":"times","reward":{"stats":{},"items":[]}}
          ]
        }
      ]
    }
  ]
  </script>

  <script type="application/json" class="enc">
  [
    {
      "id":"cache",
      "name":"Hidden Cache",
      "icon":"üó∫Ô∏è","svg":"map-marker-alt",
      "description":"You find a stash‚Ä¶",
      "trust":0,
      "questions":[
        {
          "prompt":"Open it?",
          "icon":"üóùÔ∏è","svg":"key",
          "options":[
            {"text":"Yes","icon":"üëç","svg":"thumbs-up","reward":{"stats":{"str":1},"items":["Knife"]}},
            {"text":"No","icon":"üëé","svg":"thumbs-down","reward":{"stats":{},"items":[]}}
          ]
        }
      ]
    }
  ]
  </script>

  <div id="widget">
    <div id="errorLog"></div>
    <h1>City Survivor</h1>

    <div class="card" id="card">
      <div class="inner">
        <!-- Front -->
        <div class="front">
          <div class="header">
            <div class="avatar" id="npc-avatar">üë§</div>
            <div style="display:flex; gap:8px"><div class="slot"></div><div class="slot"></div></div>
          </div>
          <div class="stats">
            <div class="stat"><small>END</small><strong id="stat-end">0</strong></div>
            <div class="stat"><small>AGI</small><strong id="stat-agi">0</strong></div>
            <div class="stat"><small>PER</small><strong id="stat-per">0</strong></div>
            <div class="stat"><small>STR</small><strong id="stat-str">0</strong></div>
            <div class="stat"><small>HUN</small><strong id="stat-hun">0</strong></div>
            <div class="stat"><small>THI</small><strong id="stat-thi">0</strong></div>
            <div class="stat"><small>MOR</small><strong id="stat-mor">0</strong></div>
            <div class="stat"><small>CHA</small><strong id="stat-cha">0</strong></div>
          </div>
          <div class="footer">
            <button id="gear-btn">Gear</button>
            <button id="inv-btn">Inv</button>
          </div>
          <button id="view-skills">View Skills</button>
          <button id="encBtn">NPC Encounter</button>
          <div id="encStatus" style="text-align:center;color:#ccc;margin-top:8px"></div>
        </div>
        <!-- Back -->
        <div class="back">
          <h3>Unlocked Skills</h3>
          <ul id="skills-list"></ul>
          <button id="view-profile">Back to Profile</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal" id="modal-enc">
    <h2 id="enc-name"></h2>
    <p id="enc-desc"></p>
    <form id="question-form"></form>
    <div class="actions"><button id="submit-answers">Submit</button></div>
  </div>
  <div class="modal" id="modal-gear"><h2>Gear</h2><p>(gear UI)</p><div class="actions"><button onclick="closeModal('modal-gear')">Close</button></div></div>
  <div class="modal" id="modal-inv"><h2>Inventory</h2><p>(inv UI)</p><div class="actions"><button onclick="closeModal('modal-inv')">Close</button></div></div>

  <script>
    // Refs
    const errorLog      = document.getElementById('errorLog'),
          card          = document.getElementById('card'),
          encBtn        = document.getElementById('encBtn'),
          viewSkillsBtn = document.getElementById('view-skills'),
          viewProfBtn   = document.getElementById('view-profile'),
          gearBtn       = document.getElementById('gear-btn'),
          invBtn        = document.getElementById('inv-btn'),
          npcAvatar     = document.getElementById('npc-avatar'),
          encName       = document.getElementById('enc-name'),
          encDesc       = document.getElementById('enc-desc'),
          qForm         = document.getElementById('question-form'),
          statusEl      = document.getElementById('encStatus'),
          skillsList    = document.getElementById('skills-list');

    let scripts     = [],    // parsed from inline <script.enc>
        npcList     = [],    // flattened encounters
        iconsMap    = {},    // loaded from icons.json
        blockIndex  = 0;

    const player    = { end:0, agi:0, per:0, str:0, hun:0, thi:0, mor:0, cha:0, inv:[], skills:[] };

    function showError(msg) {
      errorLog.textContent = msg; errorLog.style.display = 'block';
    }
    function openModal(id){document.getElementById(id).style.display='flex'}
    function closeModal(id){document.getElementById(id).style.display='none'}
    function flipBack(){card.classList.add('flip')}
    function flipFront(){card.classList.remove('flip')}

    function deriveRelationship(trust){
      if(trust>=5) return 'friend';
      if(trust<=-3) return 'enemy';
      return 'neutral';
    }

    function renderIcon(key,emoji){
      const e = `<span class="emoji">${emoji}</span>`;
      const cfg = iconsMap[key];
      if(cfg && cfg.type==='fa') return e+`<i class="${cfg.class}"></i>`;
      return e;
    }

    // Load icons.json then parse inline scripts
    function loadAll(){
      fetch('icons.json')
        .then(r=>r.json()).then(map=>{
          iconsMap = map;
          // find inline scripts
          const nodes = document.querySelectorAll('script.enc[type="application/json"]');
          scripts = Array.from(nodes).map(s=>JSON.parse(s.textContent));
          npcList = scripts.flat().map(npc=>{
            const t = typeof npc.trust==='number'?npc.trust:0;
            return {...npc, trust:t, relationship:deriveRelationship(t)};
          });
          updateStatus();
        })
        .catch(showError);
    }

    function updateStatus(){
      const rem = npcList.length - blockIndex;
      if(blockIndex===0) statusEl.textContent = `${rem} encounter(s) remaining`;
      else if(blockIndex<npcList.length){
        const next=npcList[blockIndex];
        statusEl.textContent = `${rem} remaining - Next: ${next.relationship.toUpperCase()} (trust: ${next.trust})`;
      } else statusEl.textContent='No more encounters';
    }

    function renderEncounter(){
      const npc=npcList[blockIndex];
      npcAvatar.innerHTML = renderIcon(npc.svg,npc.icon);
      encName.innerHTML   = renderIcon(npc.svg,npc.icon)+' '+npc.name;
      encDesc.textContent = npc.description;
      qForm.innerHTML='';
      npc.questions.forEach((q,qi)=>{
        const div=document.createElement('div');
        div.innerHTML = `<p>${renderIcon(q.svg||q.icon,q.icon)} ${q.prompt}</p>`+
          q.options.map((opt,oi)=>
            `<label>${renderIcon(opt.svg||opt.icon,opt.icon)} ${opt.text}
               <input type="radio" name="q${qi}" value="${oi}"/>
             </label>`
          ).join('');
        qForm.appendChild(div);
      });
    }

    function startEncounter(){
      if(blockIndex>=npcList.length) return;
      renderEncounter();
      openModal('modal-enc');
      flipBack();
    }

    function processAnswers(){
      const npc=npcList[blockIndex];
      let trustDelta=0, stats={}, items=[];
      npc.questions.forEach((q,qi)=>{
        const sel=qForm.querySelector(`input[name="q${qi}"]:checked`);
        if(sel){
          const opt=npc.questions[qi].options[+sel.value];
          Object.entries(opt.reward.stats).forEach(([k,v])=>{
            stats[k]=(stats[k]||0)+v; trustDelta+=v;
          });
          items.push(...opt.reward.items);
          trustDelta+=opt.reward.items.length*2;
        }
      });
      Object.entries(stats).forEach(([k,v])=>player[k]+=v);
      player.inv.push(...items);
      ['end','agi','per','str','hun','thi','mor','cha'].forEach(k=>
        document.getElementById('stat-'+k).textContent=player[k]
      );
      npc.trust+=trustDelta;
      npc.relationship=deriveRelationship(npc.trust);
      closeModal('modal-enc');
      flipFront();
      blockIndex++;
      updateStatus();
    }

    window.onload=()=>{
      loadAll();
      flipFront();
      encBtn.onclick        = startEncounter;
      document.getElementById('submit-answers')
        .addEventListener('click',e=>{e.preventDefault();processAnswers()});
      viewSkillsBtn.onclick = flipBack;
      viewProfBtn.onclick   = flipFront;
      gearBtn.onclick       = ()=>openModal('modal-gear');
      invBtn.onclick        = ()=>openModal('modal-inv');
    };
  </script>
</body>
</html>
